name: Deploy to AWS App Runner

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  APP_RUNNER_SERVICE_NAME: bee-edu-rag-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # 必需：用于 OIDC 认证
      contents: read   # 必需：用于检出代码

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          if [ -z "$ECR_REPOSITORY" ]; then
            echo "Error: ECR_REPOSITORY secret is not set"
            exit 1
          fi
          echo "Building Docker image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Get App Runner Service ARN
        id: get-apprunner-arn
        run: |
          if [ -n "${{ secrets.APP_RUNNER_ARN }}" ] && [ "${{ secrets.APP_RUNNER_ARN }}" != "null" ]; then
            SERVICE_ARN="${{ secrets.APP_RUNNER_ARN }}"
            echo "service_arn=$SERVICE_ARN" >> $GITHUB_OUTPUT
            echo "service_exists=true" >> $GITHUB_OUTPUT
          else
            echo "service_exists=false" >> $GITHUB_OUTPUT
            echo "App Runner service ARN not found in secrets, will create new service"
          fi

      - name: Get AWS Account ID and Secret ARN
        id: aws-info
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          # Get the full secret ARN (Secrets Manager adds random suffix)
          SECRET_ARN=$(aws secretsmanager describe-secret \
            --secret-id bee-edu-openai-key-secret \
            --region $AWS_REGION \
            --query 'ARN' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$SECRET_ARN" ]; then
            echo "Warning: Secret not found, will try without OPENAI_API_KEY"
            echo "secret_arn=" >> $GITHUB_OUTPUT
          else
            echo "secret_arn=$SECRET_ARN" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update App Runner Service
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_ARN: ${{ steps.get-apprunner-arn.outputs.service_arn }}
          ACCOUNT_ID: ${{ steps.aws-info.outputs.account_id }}
          SECRET_ARN: ${{ steps.aws-info.outputs.secret_arn }}
        run: |
          # Build runtime environment secrets JSON
          if [ -n "$SECRET_ARN" ]; then
            RUNTIME_SECRETS='{"OPENAI_API_KEY": "'$SECRET_ARN'"}'
          else
            RUNTIME_SECRETS='{}'
          fi
          
          if [ "${{ steps.get-apprunner-arn.outputs.service_exists }}" == "true" ]; then
            echo "Updating existing App Runner service..."
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "'$ECR_REGISTRY'/'$ECR_REPOSITORY':'$IMAGE_TAG'",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "8080",
                    "RuntimeEnvironmentSecrets": '$RUNTIME_SECRETS'
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::'$ACCOUNT_ID':role/bee-edu-apprunner-role"
                },
                "AutoDeploymentsEnabled": false
              }' \
              --instance-configuration '{
                "Cpu": "1024",
                "Memory": "2048",
                "InstanceRoleArn": "arn:aws:iam::'$ACCOUNT_ID':role/bee-edu-apprunner-instance-role"
              }' \
              --region $AWS_REGION
            
            echo "Waiting for service update to complete..."
            aws apprunner start-deployment \
              --service-arn "$SERVICE_ARN" \
              --region $AWS_REGION
            
            echo "Service update initiated. Deployment in progress..."
          else
            echo "Creating new App Runner service..."
            SERVICE_ARN=$(aws apprunner create-service \
              --service-name "$APP_RUNNER_SERVICE_NAME" \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "'$ECR_REGISTRY'/'$ECR_REPOSITORY':'$IMAGE_TAG'",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "8080",
                    "RuntimeEnvironmentSecrets": '$RUNTIME_SECRETS'
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "arn:aws:iam::'$ACCOUNT_ID':role/bee-edu-apprunner-role"
                },
                "AutoDeploymentsEnabled": false
              }' \
              --instance-configuration '{
                "Cpu": "1024",
                "Memory": "2048",
                "InstanceRoleArn": "arn:aws:iam::'$ACCOUNT_ID':role/bee-edu-apprunner-instance-role"
              }' \
              --region $AWS_REGION \
              --query 'Service.ServiceArn' \
              --output text)
            
            echo "service_arn=$SERVICE_ARN" >> $GITHUB_ENV
            echo "New App Runner service created: $SERVICE_ARN"
            echo "Please add this ARN to GitHub Secret APP_RUNNER_ARN for future updates"
          fi

      - name: Wait for deployment to complete
        if: steps.get-apprunner-arn.outputs.service_exists == 'true'
        env:
          SERVICE_ARN: ${{ steps.get-apprunner-arn.outputs.service_arn }}
        run: |
          echo "Waiting for deployment to stabilize..."
          MAX_WAIT=600
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws apprunner describe-service \
              --service-arn "$SERVICE_ARN" \
              --region $AWS_REGION \
              --query 'Service.Status' \
              --output text)
            
            if [ "$STATUS" == "RUNNING" ]; then
              OPERATIONS=$(aws apprunner list-operations \
                --service-arn "$SERVICE_ARN" \
                --region $AWS_REGION \
                --query 'OperationSummaryList[?Status==`IN_PROGRESS`]' \
                --output json)
              
              if [ "$OPERATIONS" == "[]" ]; then
                echo "Deployment completed successfully!"
                SERVICE_URL=$(aws apprunner describe-service \
                  --service-arn "$SERVICE_ARN" \
                  --region $AWS_REGION \
                  --query 'Service.ServiceUrl' \
                  --output text)
                echo "Service URL: $SERVICE_URL"
                exit 0
              fi
            fi
            
            echo "Status: $STATUS, waiting 10 seconds..."
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          echo "Warning: Deployment did not complete within $MAX_WAIT seconds"
          exit 0

